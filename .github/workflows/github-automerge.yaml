name: github-automerge

on:
  workflow_call:
    inputs:
      GITHUB_ENVIRONMENT:
        description: 'The environment to run the Primus GitHub operation in.'
        default: 'production'
        type: string
      PRIMUS_REF:
        description: 'The primus ref to checkout.'
        required: true
        default: 'main'
        type: string
      MERGE_METHOD:
        description: 'Method to use when merging the pull request into the base branch. Possible values are: merge, rebase, squash.'
        required: false
        type: string
        default: 'squash'
      MERGE_RETRIES:
        description: 'Number of times the job will attempt to merge the PR post performing update operation.'
        required: false
        type: string
        default: '3'
      MERGE_RETRY_SLEEP:
        description: 'Time to sleep between merge retries.'
        required: false
        type: string
        default: '30000'
      UPDATE_METHOD:
        description: 'Method to use when updating the pull request to the base branch. Possible values are: merge, rebase.'
        required: false
        type: string
        default: 'merge'
      UPDATE_RETRIES:
        description: 'Number of times the job will attempt to update the PR.'
        required: false
        type: string
        default: '3'
      UPDATE_RETRY_SLEEP:
        description: 'Time to sleep between update retries.'
        required: false
        type: string
        default: '5000'
      MAX_ATTEMPTS:
        description: 'Maximum number of automerge attempts.'
        required: false
        type: number
        default: 5

defaults:
  run:
    shell: bash

jobs:
  automerge:
    runs-on: ubuntu-latest
    permissions:
      contents: 'write'
      id-token: 'write'
      pull-requests: 'write'
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        attempt: ${{ fromJson(format('[{0}]', join(fromJson('[1,2,3,4,5,6,7,8,9,10]')[0:inputs.MAX_ATTEMPTS], ','))) }}
    steps:
      - name: self-checkout
        uses: actions/checkout@v4
      - id: token
        name: github-token-gen
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ inputs.GITHUB_ENVIRONMENT == 'production' && secrets.PRIMUS_APP_ID || secrets.NP_PRIMUS_APP_ID }}
          private-key: ${{ inputs.GITHUB_ENVIRONMENT == 'production' && secrets.PRIMUS_PRIVATE_KEY || secrets.NP_PRIMUS_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
      - name: Attempt automerge ${{ matrix.attempt }}
        id: automerge
        uses: pascalgn/automerge-action@v0.16.4
        env:
          GITHUB_TOKEN: ${{ steps.token.outputs.token }}
          MERGE_METHOD: ${{ inputs.MERGE_METHOD }}
          MERGE_RETRIES: ${{ inputs.MERGE_RETRIES }}
          MERGE_RETRY_SLEEP: ${{ inputs.MERGE_RETRY_SLEEP }}
          UPDATE_METHOD: ${{ inputs.UPDATE_METHOD }}
          UPDATE_RETRIES: ${{ inputs.UPDATE_RETRIES }}
          UPDATE_RETRY_SLEEP: ${{ inputs.UPDATE_RETRY_SLEEP }}
      - name: Notify Slack if final attempt failed
        if: >
          matrix.attempt == inputs.MAX_ATTEMPTS &&
          always() &&
          (steps.automerge.outputs.mergeResult == 'merge_failed' || steps.automerge.outputs.mergeResult == 'not_ready')
        uses: slackapi/slack-github-action@v2.1.1
        with:
          payload: |
            {
              "text": "automerge failed after ${{ inputs.MAX_ATTEMPTS }} attempts",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "Workflow `${{ github.workflow }}` failed in job `automerge` after ${{ inputs.MAX_ATTEMPTS }} attempts\nPR: <#${{ github.event.pull_request.number }}> (${{ github.event.pull_request.html_url }})\nRun: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                }
              ]
            }
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
