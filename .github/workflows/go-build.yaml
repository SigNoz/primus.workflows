name: go-build
on:
  workflow_call:
    inputs:
      PRIMUS_REF:
        description: 'The primus ref to checkout.'
        required: true
        default: 'main'
        type: string
      GO_NAME:
        description: 'The name of the go project.'
        type: string
      GO_DOWNLOAD_ARTIFACT_NAME:
        description: 'The artifact name to download.'
        type: string
      GO_DOWNLOAD_ARTIFACT_PATH:
        description: 'Path of the artifact to download.'
        type: string
      GO_DOWNLOAD_ARTIFACT_REPO:
        description: 'The repository to download the artifact from. If not provided, the default is the current repository.'
        type: string
      GO_DOWNLOAD_ARTIFACT_RUN_ID:
        description: 'The run id of the artifact to download. If not provided, the default is the current run id.'
        type: string
      GO_BUILD_CONTEXT:
        description: 'The directory path containing the main package.'
        required: true
        type: string
      GO_BUILD_FLAGS:
        description: 'Additional build flags to be passed.'
        required: true
        type: string
      GO_CGO_ENABLED:
        description: 'Whether to enable CGO. Set to 1 to enable CGO. If not provided, the default is 0.'
        default: '0'
        type: string
      DOCKER_BASE_IMAGES:
        description: 'List of docker base images in json.'
        required: true
        type: string
      DOCKER_DOCKERFILE_PATH:
        description: 'Path to dockerfile.'
        required: true
        type: string
      DOCKER_MANIFEST:
        description: 'Whether to push the docker image or not.'
        required: true
        type: boolean
      DOCKER_PROVIDERS:
        description: 'The docker providers to use, separated by commas. (hub, gcp, aws)'
        default: 'hub'
        type: string

defaults:
  run:
    shell: bash

env:
  PRIMUS_HOME: .primus
  MAKE: make --no-print-directory --makefile=.primus/src/make/main.mk

jobs:
  go:
    runs-on: ubuntu-latest
    environment: ${{ github.ref_type == 'tag' && 'production' || github.ref_name == 'main' && 'staging' || 'review' }}
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - name: self-checkout
        uses: actions/checkout@v4
      - id: token
        name: github-token-gen
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.PRIMUS_APP_ID }}
          private-key: ${{ secrets.PRIMUS_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
      - name: primus-checkout
        uses: actions/checkout@v4
        with:
          repository: signoz/primus
          ref: ${{ inputs.PRIMUS_REF }}
          path: .primus
          token: ${{ steps.token.outputs.token }}
      - name: qemu-install
        uses: docker/setup-qemu-action@v3
      - name: go-install
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
      - name: info
        run: |
          $MAKE info
      - name: download-artifact
        if: ${{ inputs.GO_DOWNLOAD_ARTIFACT_NAME && inputs.GO_DOWNLOAD_ARTIFACT_PATH }}
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.GO_DOWNLOAD_ARTIFACT_NAME }}
          path: ${{ inputs.GO_DOWNLOAD_ARTIFACT_PATH }}
          repository: ${{ inputs.GO_DOWNLOAD_ARTIFACT_REPO || github.repository }}
          run-id: ${{ inputs.GO_DOWNLOAD_ARTIFACT_RUN_ID || github.run_id }}
      - name: cross-compilation-tools
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu musl-tools
      - name: go-build
        run: |
          if [ -n "${{ inputs.GO_NAME }}" ]; then
            $MAKE go-build NAME="${{ inputs.GO_NAME }}" GO_BUILD_CONTEXT="${{ inputs.GO_BUILD_CONTEXT }}" GO_BUILD_FLAGS="${{ inputs.GO_BUILD_FLAGS }}" GO_CGO_ENABLED="${{ inputs.GO_CGO_ENABLED }}"
          else
            $MAKE go-build GO_BUILD_CONTEXT="${{ inputs.GO_BUILD_CONTEXT }}" GO_BUILD_FLAGS="${{ inputs.GO_BUILD_FLAGS }}" GO_CGO_ENABLED="${{ inputs.GO_CGO_ENABLED }}"
          fi
      - name: docker-build
        run: |
          if [ -n "${{ inputs.GO_NAME }}" ]; then
            $MAKE docker-build NAME="${{ inputs.GO_NAME }}" DOCKER_BASE_IMAGES='${{ inputs.DOCKER_BASE_IMAGES }}' DOCKER_DOCKERFILE_PATH="${{ inputs.DOCKER_DOCKERFILE_PATH }}"
          else
            $MAKE docker-build DOCKER_BASE_IMAGES='${{ inputs.DOCKER_BASE_IMAGES }}' DOCKER_DOCKERFILE_PATH="${{ inputs.DOCKER_DOCKERFILE_PATH }}"
          fi
      - name: docker-auth-credentials
        if: ${{ inputs.DOCKER_MANIFEST && contains(inputs.DOCKER_PROVIDERS, 'hub') }}
        run: |
          echo "HUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}" >> $GITHUB_ENV
          echo "HUB_TOKEN=${{ secrets.DOCKERHUB_TOKEN }}" >> $GITHUB_ENV
      - name: gcp-auth-prepare
        if: ${{ inputs.DOCKER_MANIFEST && contains(inputs.DOCKER_PROVIDERS, 'gcp') }}
        run: |
          echo "GCP_PROJECT_ID=$($MAKE signoz-gcp-project-id)" >> $GITHUB_ENV
          echo "GCP_WORKLOAD_IDENTITY_PROVIDER=$($MAKE signoz-gcp-workload-identity-provider)" >> $GITHUB_ENV
          echo "GCP_SERVICE_ACCOUNT=$($MAKE signoz-gcp-service-account)" >> $GITHUB_ENV
      - name: gcp-auth
        if: ${{ inputs.DOCKER_MANIFEST && contains(inputs.DOCKER_PROVIDERS, 'gcp') }}
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: ${{ env.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.GCP_SERVICE_ACCOUNT }}
      - name: sdk-install
        if: ${{ inputs.DOCKER_MANIFEST && contains(inputs.DOCKER_PROVIDERS, 'gcp') }}
        uses: 'google-github-actions/setup-gcloud@v2'
      - name: docker-manifest
        if: ${{ inputs.DOCKER_MANIFEST }}
        run: |
          IFS=',' read -ra PROVIDERS <<< "${{ inputs.DOCKER_PROVIDERS }}"
          for provider in "${PROVIDERS[@]}"; do
            echo "Building manifest for the $provider provider"
            if [ -n "${{ inputs.GO_NAME }}" ]; then
              $MAKE docker-login-$provider docker-push docker-manifest NAME="${{ inputs.GO_NAME }}" DOCKER_BASE_IMAGES='${{ inputs.DOCKER_BASE_IMAGES }}' DOCKER_DOCKERFILE_PATH="${{ inputs.DOCKER_DOCKERFILE_PATH }}"
            else
              $MAKE docker-login-$provider docker-push docker-manifest DOCKER_BASE_IMAGES='${{ inputs.DOCKER_BASE_IMAGES }}' DOCKER_DOCKERFILE_PATH="${{ inputs.DOCKER_DOCKERFILE_PATH }}"
            fi
          done
