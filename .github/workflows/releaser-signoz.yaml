name: releaser-signoz

on:
  workflow_call:
    inputs:
      PRIMUS_REF:
        description: 'The primus ref to checkout.'
        required: true
        default: 'main'
        type: string

defaults:
  run:
    shell: bash

env:
  PRIMUS_HOME: .primus
  MAKE: make --no-print-directory --makefile=.primus/src/make/main.mk

jobs:
  go:
    runs-on: ubuntu-latest
    permissions:
      contents: 'write'
      id-token: 'write'
      pull-requests: 'write'
      repository-projects: 'write'
    steps:
      - name: self-checkout
        uses: actions/checkout@v4
      - id: token
        name: github-token-gen
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.PRIMUS_APP_ID }}
          private-key: ${{ secrets.PRIMUS_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
      - name: primus-checkout
        uses: actions/checkout@v4
        with:
          repository: signoz/primus
          ref: ${{ inputs.PRIMUS_REF }}
          path: .primus
          token: ${{ steps.token.outputs.token }}
      - name: git-configure
        run: |
          git config --global user.name "primus-bot[bot]"
          git config --global user.email "171087277+primus-bot[bot]@users.noreply.github.com"
      - name: info
        run: |
          $MAKE info
      - name: generate-release-version
        run: |
          RELEASE_VERSION=$(curl -s https://api.github.com/repos/signoz/signoz/releases/latest | jq -r '.tag_name')
          MAJOR_VERSION=$(echo $RELEASE_VERSION | cut -d. -f1 | tr -d 'v')
          MINOR_VERSION=$(echo $RELEASE_VERSION | cut -d. -f2)
          NEW_MINOR_VERSION=$((MINOR_VERSION + 1))
          NEW_RELEASE_VERSION="v${MAJOR_VERSION}.${NEW_MINOR_VERSION}.0"
          echo "NEW_RELEASE_VERSION=${NEW_RELEASE_VERSION}" >> $GITHUB_ENV
      - name: releaser-signoz
        run: |
          $MAKE releaser-signoz RELEASER_ARGS="-v ${{ env.NEW_RELEASE_VERSION }}"
      - name: create-pr
        env:
          GH_TOKEN: ${{ steps.token.outputs.token }}
          RELEASE_VERSION: ${{ env.NEW_RELEASE_VERSION }}
        run: |
          git checkout -b release-${RELEASE_VERSION}
          git add .
          git commit -m 'Release ${RELEASE_VERSION}'
          git push origin release-${RELEASE_VERSION}
          echo -e "#### Summary\n - Release SigNoz ${RELEASE_VERSION}\n\n Created by [Primus-Bot](https://github.com/apps/primus-bot)\n\n" > release-msg.txt
          export RELEASE_PR_BODY=$(cat release-msg.txt)
          rm release-msg.txt
          gh pr create -B main -H release-${RELEASE_VERSION} --title 'chore(release): bump to ${RELEASE_VERSION}' --body "${RELEASE_PR_BODY}"
